<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial AI - Advanced Trading & Portfolio Management</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --dark-color: #34495e;
            --light-color: #ecf0f1;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: rgba(44, 62, 80, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: #3498db !important;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }
        
        .card-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            border: none;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
        }
        
        .form-control {
            border-radius: 10px;
            border: 2px solid #ecf0f1;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        
        .metric-card {
            text-align: center;
            padding: 20px;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .metric-label {
            color: #7f8c8d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .signal-buy {
            color: var(--success-color);
            font-weight: 700;
        }
        
        .signal-sell {
            color: var(--danger-color);
            font-weight: 700;
        }
        
        .signal-hold {
            color: var(--warning-color);
            font-weight: 700;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner-border {
            color: var(--secondary-color);
        }
        
        .alert {
            border-radius: 10px;
            border: none;
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table thead th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            border: none;
            font-weight: 600;
        }
        
        .portfolio-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .card {
                margin-bottom: 20px;
            }
            
            .metric-value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-brain me-2"></i>Financial AI
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#portfolio">Portfolio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#trading">Trading</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#ai">AI Models</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid" style="margin-top: 80px;">
        
        <!-- Dashboard Section -->
        <section id="dashboard">
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="text-white text-center mb-4">
                        <i class="fas fa-chart-line me-3"></i>Financial AI Dashboard
                    </h1>
                    <p class="text-white text-center lead">Advanced AI-powered financial analysis, portfolio optimization, and trading strategies</p>
                </div>
            </div>

            <!-- Market Overview -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-globe me-2"></i>Market Overview
                        </div>
                        <div class="card-body">
                            <div id="marketOverview" class="row">
                                <!-- Market data will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stock Analysis -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-search me-2"></i>Stock Analysis
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="stockSymbol" class="form-label">Stock Symbol</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="stockSymbol" placeholder="e.g., AAPL, GOOGL">
                                    <button class="btn btn-primary" type="button" onclick="analyzeStock()">
                                        <i class="fas fa-search me-2"></i>Analyze
                                    </button>
                                </div>
                            </div>
                            <div id="stockAnalysis" class="mt-3">
                                <!-- Stock analysis results will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-area me-2"></i>Price Chart
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="priceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Portfolio Section -->
        <section id="portfolio" class="mb-4">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-briefcase me-2"></i>Portfolio Management
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h5>Create Portfolio</h5>
                                    <div class="mb-3">
                                        <label for="portfolioSymbols" class="form-label">Stock Symbols (comma-separated)</label>
                                        <input type="text" class="form-control" id="portfolioSymbols" placeholder="AAPL, GOOGL, MSFT">
                                    </div>
                                    <div class="mb-3">
                                        <label for="portfolioStrategy" class="form-label">Strategy</label>
                                        <select class="form-control" id="portfolioStrategy">
                                            <option value="equal_weight">Equal Weight</option>
                                            <option value="market_cap">Market Cap</option>
                                            <option value="risk_parity">Risk Parity</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="initialCapital" class="form-label">Initial Capital ($)</label>
                                        <input type="number" class="form-control" id="initialCapital" value="100000">
                                    </div>
                                    <button class="btn btn-success" onclick="createPortfolio()">
                                        <i class="fas fa-plus me-2"></i>Create Portfolio
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <h5>Portfolio Actions</h5>
                                    <button class="btn btn-primary me-2 mb-2" onclick="optimizePortfolio()">
                                        <i class="fas fa-cogs me-2"></i>Optimize
                                    </button>
                                    <button class="btn btn-warning me-2 mb-2" onclick="getPortfolioSummary()">
                                        <i class="fas fa-chart-pie me-2"></i>Summary
                                    </button>
                                    <button class="btn btn-info me-2 mb-2" onclick="exportPortfolio()">
                                        <i class="fas fa-download me-2"></i>Export
                                    </button>
                                </div>
                            </div>
                            <div id="portfolioResults" class="mt-3">
                                <!-- Portfolio results will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Trading Section -->
        <section id="trading" class="mb-4">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-signal me-2"></i>Trading Signals
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="signalSymbol" class="form-label">Stock Symbol</label>
                                <input type="text" class="form-control" id="signalSymbol" placeholder="e.g., AAPL">
                            </div>
                            <div class="mb-3">
                                <label for="signalStrategy" class="form-label">Strategy</label>
                                <select class="form-control" id="signalStrategy">
                                    <option value="combined">Combined</option>
                                    <option value="moving_average_crossover">Moving Average Crossover</option>
                                    <option value="rsi_strategy">RSI Strategy</option>
                                    <option value="bollinger_bands">Bollinger Bands</option>
                                    <option value="macd_strategy">MACD Strategy</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="getTradingSignals()">
                                <i class="fas fa-signal me-2"></i>Get Signals
                            </button>
                            <div id="tradingSignals" class="mt-3">
                                <!-- Trading signals will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-bar me-2"></i>Strategy Backtest
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="backtestSymbol" class="form-label">Stock Symbol</label>
                                <input type="text" class="form-control" id="backtestSymbol" placeholder="e.g., AAPL">
                            </div>
                            <div class="mb-3">
                                <label for="backtestStrategy" class="form-label">Strategy</label>
                                <select class="form-control" id="backtestStrategy">
                                    <option value="combined">Combined</option>
                                    <option value="moving_average_crossover">Moving Average Crossover</option>
                                    <option value="rsi_strategy">RSI Strategy</option>
                                </select>
                            </div>
                            <button class="btn btn-warning" onclick="runBacktest()">
                                <i class="fas fa-play me-2"></i>Run Backtest
                            </button>
                            <div id="backtestResults" class="mt-3">
                                <!-- Backtest results will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- AI Models Section -->
        <section id="ai" class="mb-4">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-robot me-2"></i>AI Model Training
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="trainSymbol" class="form-label">Stock Symbol</label>
                                <input type="text" class="form-control" id="trainSymbol" placeholder="e.g., AAPL">
                            </div>
                            <div class="mb-3">
                                <label for="modelType" class="form-label">Model Type</label>
                                <select class="form-control" id="modelType">
                                    <option value="all">All Models</option>
                                    <option value="ml">Machine Learning</option>
                                    <option value="lstm">LSTM Neural Network</option>
                                    <option value="cnn">CNN Neural Network</option>
                                </select>
                            </div>
                            <button class="btn btn-success" onclick="trainModels()">
                                <i class="fas fa-brain me-2"></i>Train Models
                            </button>
                            <div id="trainingResults" class="mt-3">
                                <!-- Training results will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-crystal-ball me-2"></i>AI Predictions
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="predictSymbol" class="form-label">Stock Symbol</label>
                                <input type="text" class="form-control" id="predictSymbol" placeholder="e.g., AAPL">
                            </div>
                            <div class="mb-3">
                                <label for="predictModel" class="form-label">Model</label>
                                <select class="form-control" id="predictModel">
                                    <option value="ensemble">Ensemble</option>
                                    <option value="RandomForest">Random Forest</option>
                                    <option value="LSTM">LSTM</option>
                                    <option value="CNN">CNN</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="getPredictions()">
                                <i class="fas fa-magic me-2"></i>Get Predictions
                            </button>
                            <div id="predictionResults" class="mt-3">
                                <!-- Prediction results will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Loading Spinner -->
    <div id="loading" class="loading">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Processing...</p>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Global variables
        let currentChart = null;
        let currentPortfolio = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadMarketOverview();
        });

        // Market Overview
        async function loadMarketOverview() {
            try {
                const response = await fetch('/api/market/overview');
                const data = await response.json();
                
                if (data.error) {
                    showAlert('Error loading market overview: ' + data.error, 'danger');
                    return;
                }
                
                displayMarketOverview(data.market_overview);
            } catch (error) {
                showAlert('Error loading market overview: ' + error.message, 'danger');
            }
        }

        function displayMarketOverview(marketData) {
            const container = document.getElementById('marketOverview');
            container.innerHTML = '';
            
            Object.entries(marketData).forEach(([symbol, data]) => {
                const changeClass = data.change >= 0 ? 'text-success' : 'text-danger';
                const changeIcon = data.change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                
                const marketCard = `
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-title">${data.name}</h6>
                                <div class="metric-value">${data.current.toFixed(2)}</div>
                                <div class="metric-label">
                                    <i class="fas ${changeIcon} ${changeClass} me-1"></i>
                                    ${data.change.toFixed(2)} (${(data.change_pct * 100).toFixed(2)}%)
                                </div>
                                <small class="text-muted">Volume: ${data.volume.toLocaleString()}</small>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += marketCard;
            });
        }

        // Stock Analysis
        async function analyzeStock() {
            const symbol = document.getElementById('stockSymbol').value.trim().toUpperCase();
            if (!symbol) {
                showAlert('Please enter a stock symbol', 'warning');
                return;
            }
            
            showLoading();
            
            try {
                // Get stock data
                const dataResponse = await fetch(`/api/stocks/${symbol}?period=1y`);
                const dataResult = await dataResponse.json();
                
                if (dataResult.error) {
                    showAlert('Error loading stock data: ' + dataResult.error, 'danger');
                    hideLoading();
                    return;
                }
                
                // Get company info
                const infoResponse = await fetch(`/api/stocks/${symbol}/info`);
                const infoResult = await infoResponse.json();
                
                if (infoResult.error) {
                    showAlert('Error loading company info: ' + infoResult.error, 'danger');
                    hideLoading();
                    return;
                }
                
                // Display results
                displayStockAnalysis(symbol, dataResult.data, infoResult);
                displayPriceChart(symbol, dataResult.data);
                
            } catch (error) {
                showAlert('Error analyzing stock: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        function displayStockAnalysis(symbol, data, info) {
            const container = document.getElementById('stockAnalysis');
            
            if (data.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">No data available for this symbol</div>';
                return;
            }
            
            const latest = data[data.length - 1];
            const previous = data[data.length - 2];
            const change = latest.Close - previous.Close;
            const changePct = (change / previous.Close) * 100;
            
            const changeClass = change >= 0 ? 'text-success' : 'text-danger';
            const changeIcon = change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            
            container.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h5>${info.name || symbol}</h5>
                        <div class="metric-value ${changeClass}">
                            $${latest.Close.toFixed(2)}
                            <i class="fas ${changeIcon} ms-2"></i>
                        </div>
                        <div class="metric-label">
                            ${change.toFixed(2)} (${changePct.toFixed(2)}%)
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                Volume: ${latest.Volume.toLocaleString()}<br>
                                Sector: ${info.sector || 'N/A'}<br>
                                Market Cap: ${info.market_cap ? '$' + (info.market_cap / 1e9).toFixed(2) + 'B' : 'N/A'}
                            </small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Technical Indicators</h6>
                        <div class="row">
                            <div class="col-6">
                                <div class="metric-label">RSI</div>
                                <div class="metric-value">${latest.RSI ? latest.RSI.toFixed(2) : 'N/A'}</div>
                            </div>
                            <div class="col-6">
                                <div class="metric-label">MACD</div>
                                <div class="metric-value">${latest.MACD ? latest.MACD.toFixed(4) : 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function displayPriceChart(symbol, data) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (currentChart) {
                currentChart.destroy();
            }
            
            const chartData = {
                labels: data.map(d => new Date(d.Date).toLocaleDateString()),
                datasets: [{
                    label: `${symbol} Price`,
                    data: data.map(d => d.Close),
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.1
                }]
            };
            
            currentChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // Portfolio Management
        async function createPortfolio() {
            const symbols = document.getElementById('portfolioSymbols').value.trim();
            const strategy = document.getElementById('portfolioStrategy').value;
            const capital = parseFloat(document.getElementById('initialCapital').value);
            
            if (!symbols) {
                showAlert('Please enter stock symbols', 'warning');
                return;
            }
            
            const symbolList = symbols.split(',').map(s => s.trim().toUpperCase());
            
            showLoading();
            
            try {
                const response = await fetch('/api/portfolio/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbols: symbolList,
                        strategy: strategy,
                        initial_capital: capital
                    })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    showAlert('Error creating portfolio: ' + result.error, 'danger');
                } else {
                    currentPortfolio = result.portfolio;
                    showAlert('Portfolio created successfully!', 'success');
                    displayPortfolioResults(result.portfolio);
                }
                
            } catch (error) {
                showAlert('Error creating portfolio: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        async function optimizePortfolio() {
            if (!currentPortfolio) {
                showAlert('Please create a portfolio first', 'warning');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch('/api/portfolio/optimize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbols: currentPortfolio.symbols,
                        method: 'sharpe_ratio'
                    })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    showAlert('Error optimizing portfolio: ' + result.error, 'danger');
                } else {
                    showAlert('Portfolio optimized successfully!', 'success');
                    displayPortfolioResults(currentPortfolio);
                }
                
            } catch (error) {
                showAlert('Error optimizing portfolio: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        async function getPortfolioSummary() {
            if (!currentPortfolio) {
                showAlert('Please create a portfolio first', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/portfolio/summary');
                const result = await response.json();
                
                if (result.error) {
                    showAlert('Error getting portfolio summary: ' + result.error, 'danger');
                } else {
                    displayPortfolioResults(result);
                }
                
            } catch (error) {
                showAlert('Error getting portfolio summary: ' + error.message, 'danger');
            }
        }

        function displayPortfolioResults(portfolio) {
            const container = document.getElementById('portfolioResults');
            
            let positionsHtml = '';
            if (portfolio.positions) {
                positionsHtml = `
                    <h6>Positions</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Weight</th>
                                    <th>Value</th>
                                    <th>Shares</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(portfolio.positions).map(([symbol, pos]) => `
                                    <tr>
                                        <td>${symbol}</td>
                                        <td>${(pos.weight * 100).toFixed(2)}%</td>
                                        <td>$${pos.value.toLocaleString()}</td>
                                        <td>${pos.shares.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div class="portfolio-summary">
                    <h5>Portfolio Summary</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="metric-value">${portfolio.total_assets || 0}</div>
                            <div class="metric-label">Total Assets</div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-value">$${(portfolio.total_capital || 0).toLocaleString()}</div>
                            <div class="metric-label">Total Capital</div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-value">${portfolio.created_date ? new Date(portfolio.created_date).toLocaleDateString() : 'N/A'}</div>
                            <div class="metric-label">Created Date</div>
                        </div>
                    </div>
                </div>
                ${positionsHtml}
            `;
        }

        function exportPortfolio() {
            if (!currentPortfolio) {
                showAlert('Please create a portfolio first', 'warning');
                return;
            }
            
            // Create CSV content
            const csvContent = [
                ['Symbol', 'Weight', 'Value', 'Shares'],
                ...Object.entries(currentPortfolio.positions).map(([symbol, pos]) => [
                    symbol,
                    (pos.weight * 100).toFixed(2) + '%',
                    '$' + pos.value.toLocaleString(),
                    pos.shares.toFixed(2)
                ])
            ].map(row => row.join(',')).join('\n');
            
            // Download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'portfolio.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            showAlert('Portfolio exported successfully!', 'success');
        }

        // Trading Strategies
        async function getTradingSignals() {
            const symbol = document.getElementById('signalSymbol').value.trim().toUpperCase();
            const strategy = document.getElementById('signalStrategy').value;
            
            if (!symbol) {
                showAlert('Please enter a stock symbol', 'warning');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`/api/trading/signals/${symbol}?strategy=${strategy}`);
                const result = await response.json();
                
                if (result.error) {
                    showAlert('Error getting trading signals: ' + result.error, 'danger');
                } else {
                    displayTradingSignals(result);
                }
                
            } catch (error) {
                showAlert('Error getting trading signals: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        function displayTradingSignals(signals) {
            const container = document.getElementById('tradingSignals');
            
            let signalHtml = '<h6>Latest Signals</h6>';
            
            if (signals.strategy === 'combined') {
                const finalSignal = signals.signals.Final_Signal;
                const signalClass = finalSignal === 1 ? 'signal-buy' : finalSignal === -1 ? 'signal-sell' : 'signal-hold';
                const signalText = finalSignal === 1 ? 'BUY' : finalSignal === -1 ? 'SELL' : 'HOLD';
                
                signalHtml += `
                    <div class="alert alert-info">
                        <strong>Final Signal:</strong> <span class="${signalClass}">${signalText}</span><br>
                        <strong>Signal Strength:</strong> ${signals.signals.Combined_Signal ? signals.signals.Combined_Signal.toFixed(3) : 'N/A'}<br>
                        <strong>Strategy:</strong> ${signals.strategy}<br>
                        <strong>Timestamp:</strong> ${new Date(signals.timestamp).toLocaleString()}
                    </div>
                `;
            } else {
                // Display individual strategy signals
                const signalColumns = Object.keys(signals.signals).filter(key => key.includes('Signal'));
                signalColumns.forEach(col => {
                    const value = signals.signals[col];
                    if (typeof value === 'number') {
                        const signalClass = value === 1 ? 'signal-buy' : value === -1 ? 'signal-sell' : 'signal-hold';
                        const signalText = value === 1 ? 'BUY' : value === -1 ? 'SELL' : 'HOLD';
                        
                        signalHtml += `
                            <div class="mb-2">
                                <strong>${col}:</strong> <span class="${signalClass}">${signalText}</span>
                            </div>
                        `;
                    }
                });
            }
            
            container.innerHTML = signalHtml;
        }

        async function runBacktest() {
            const symbol = document.getElementById('backtestSymbol').value.trim().toUpperCase();
            const strategy = document.getElementById('backtestStrategy').value;
            
            if (!symbol) {
                showAlert('Please enter a stock symbol', 'warning');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`/api/backtest/${symbol}?strategy=${strategy}&initial_capital=100000`);
                const result = await response.json();
                
                if (result.error) {
                    showAlert('Error running backtest: ' + result.error, 'danger');
                } else {
                    displayBacktestResults(result);
                }
                
            } catch (error) {
                showAlert('Error running backtest: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        function displayBacktestResults(results) {
            const container = document.getElementById('backtestResults');
            
            const performanceClass = results.total_return >= 0 ? 'text-success' : 'text-danger';
            
            container.innerHTML = `
                <h6>Backtest Results</h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="metric-label">Total Return</div>
                        <div class="metric-value ${performanceClass}">${(results.total_return * 100).toFixed(2)}%</div>
                    </div>
                    <div class="col-md-6">
                        <div class="metric-label">Annualized Return</div>
                        <div class="metric-value">${(results.annualized_return * 100).toFixed(2)}%</div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <div class="metric-label">Sharpe Ratio</div>
                        <div class="metric-value">${results.sharpe_ratio.toFixed(3)}</div>
                    </div>
                    <div class="col-md-6">
                        <div class="metric-label">Max Drawdown</div>
                        <div class="metric-value text-danger">${(results.max_drawdown * 100).toFixed(2)}%</div>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        Total Trades: ${results.total_trades} | 
                        Win Rate: ${(results.win_rate * 100).toFixed(1)}%
                    </small>
                </div>
            `;
        }

        // AI Models
        async function trainModels() {
            const symbol = document.getElementById('trainSymbol').value.trim().toUpperCase();
            const modelType = document.getElementById('modelType').value;
            
            if (!symbol) {
                showAlert('Please enter a stock symbol', 'warning');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch('/api/ai/train', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        model_type: modelType
                    })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    showAlert('Error training models: ' + result.error, 'danger');
                } else {
                    showAlert('Models trained successfully!', 'success');
                    displayTrainingResults(result.results);
                }
                
            } catch (error) {
                showAlert('Error training models: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        function displayTrainingResults(results) {
            const container = document.getElementById('trainingResults');
            
            let resultsHtml = '<h6>Training Results</h6>';
            
            Object.entries(results).forEach(([modelType, result]) => {
                if (result && typeof result === 'object') {
                    resultsHtml += `
                        <div class="alert alert-success">
                            <strong>${modelType.toUpperCase()}:</strong><br>
                            RÂ² Score: ${result.r2 ? result.r2.toFixed(4) : 'N/A'}<br>
                            RMSE: ${result.rmse ? result.rmse.toFixed(4) : 'N/A'}<br>
                            MAE: ${result.mae ? result.mae.toFixed(4) : 'N/A'}
                        </div>
                    `;
                }
            });
            
            container.innerHTML = resultsHtml;
        }

        async function getPredictions() {
            const symbol = document.getElementById('predictSymbol').value.trim().toUpperCase();
            const model = document.getElementById('predictModel').value;
            
            if (!symbol) {
                showAlert('Please enter a stock symbol', 'warning');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`/api/ai/predict/${symbol}?model=${model}`);
                const result = await response.json();
                
                if (result.error) {
                    showAlert('Error getting predictions: ' + result.error, 'danger');
                } else {
                    displayPredictions(result);
                }
                
            } catch (error) {
                showAlert('Error getting predictions: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        function displayPredictions(prediction) {
            const container = document.getElementById('predictionResults');
            
            const changeClass = prediction.predicted_change >= 0 ? 'text-success' : 'text-danger';
            const changeIcon = prediction.predicted_change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            
            container.innerHTML = `
                <h6>AI Prediction</h6>
                <div class="alert alert-info">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="metric-label">Current Price</div>
                            <div class="metric-value">$${prediction.current_price.toFixed(2)}</div>
                        </div>
                        <div class="col-md-6">
                            <div class="metric-label">Predicted Price</div>
                            <div class="metric-value">$${prediction.predicted_price.toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <div class="metric-label">Predicted Change</div>
                            <div class="metric-value ${changeClass}">
                                ${(prediction.predicted_change * 100).toFixed(2)}%
                                <i class="fas ${changeIcon} ms-2"></i>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="metric-label">Model</div>
                            <div class="metric-value">${prediction.model}</div>
                        </div>
                    </div>
                    <small class="text-muted">
                        Timestamp: ${new Date(prediction.timestamp).toLocaleString()}
                    </small>
                </div>
            `;
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at the top of the container
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Smooth scrolling for navigation
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
    </script>
</body>
</html>